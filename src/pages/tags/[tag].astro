---
import DefaultLayout from '~/layouts/DefaultLayout.astro';
import path from 'node:path';

export async function getStaticPaths() {
  const modules = import.meta.glob('/src/content/posts/*/index.md', { eager: true });
  const tagSet = new Set();

  for (const mod of Object.values(modules)) {
    const tags = mod.frontmatter?.tags ?? [];
    tags.forEach(tag => tagSet.add(tag));
  }

  return Array.from(tagSet).map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const modules = import.meta.glob('/src/content/posts/*/index.md', { eager: true });

const posts = Object.entries(modules).map(([filePath, mod]) => {
  const normalized = path.normalize(filePath);
  const slug = path.basename(path.dirname(normalized));
  const frontmatter = mod.frontmatter ?? {};

  return {
    slug,
    title: frontmatter.title || slug,
    description: frontmatter.description || '',
    pubDate: frontmatter.pubDate || '',
    tags: frontmatter.tags || [],
  };
});

const filtered = posts.filter(post => post.tags.includes(tag));
const title = `Tag: ${tag}`;
const description = `"${tag}" 태그를 가진 게시물`;
---

<DefaultLayout {title} {description}>
  <h2>#{tag}</h2>

  {filtered.length === 0 ? (
    <p>해당 태그의 게시물이 없습니다.</p>
  ) : (
    <ul>
      {filtered.map(post => (
        <li>
          <a href={`/${post.slug}`}>
            <strong>{post.title}</strong>
          </a>
          <br/>
          <small>{new Date(post.pubDate).toLocaleDateString()}</small>
          <p>{post.description}</p>
        </li>
      ))}
    </ul>
  )}
</DefaultLayout>
